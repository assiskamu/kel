<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KALKULATOR PROJEK MADU KELULUT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f5f7fb;
      color: #222;
    }
    h1 {
      text-align: center;
      color: #0056b3;
      margin-bottom: 4px;
    }
    h2 {
      text-align: center;
      color: #0069d9;
      margin-top: 0;
    }
    .container {
      max-width: 750px;
      margin: auto;
      background: #ffffff;
      padding: 12px 14px 18px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 14px;
      border: 1px solid #cbd2e0;
      border-radius: 4px;
    }
    button {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      font-size: 15px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #0056b3;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #d0d7e6;
      padding: 4px;
      text-align: right;
    }
    th {
      background: #e6eefc;
    }
    .summary p {
      margin: 4px 0;
    }
    .note {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }
    .section-title {
      margin-top: 15px;
      font-weight: bold;
      color: #0056b3;
      border-bottom: 2px solid #d0e2ff;
      padding-bottom: 2px;
    }
    canvas {
      margin-top: 10px;
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #e0e4f0;
    }
    .result-box {
      background: #e9f5ff;
      border-left: 4px solid #007bff;
      padding: 8px 10px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .conclusion-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 4px;
      border-left: 4px solid #999;
      font-size: 13px;
    }
    .conclusion-good {
      background: #e6ffed;
      border-left-color: #28a745;
    }
    .conclusion-moderate {
      background: #fff9e6;
      border-left-color: #ff9800;
    }
    .conclusion-bad {
      background: #ffe6e6;
      border-left-color: #e53935;
    }
    .conclusion-title {
      font-weight: bold;
      font-size: 15px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>KALKULATOR PROJEK MADU KELULUT</h1>
  <h2>Analisis Kewangan</h2>

  <p class="note">
    Hai semua! Kalkulator ini menggunakan unit <strong>ekar</strong> dan memecahkan kos kepada:
    pembangunan, bahan input, tenaga kerja dan pelbagai (penyelenggaraan & utiliti).
    Kos kontinjensi 10% ditambah secara automatik setiap tahun.
    <br><br>
    <strong>Cara guna ringkas:</strong>
    <ol>
      <li>Isi keluasan, kepadatan koloni dan hasil madu per koloni setahun.</li>
      <li>Isi harga jual madu dan anggaran kos (boleh guna nilai cadangan atau ubah ikut keadaan sendiri).</li>
      <li>Tekan <strong>Kira Analisis</strong>.</li>
      <li>Semak jadual penunjuk kewangan, kesimpulan dan graf-graf di bawah.</li>
    </ol>
  </p>

  <!-- A. Maklumat Ladang -->
  <div class="section-title">A. Maklumat Ladang</div>
  <label>Keluasan (ekar):
    <input id="areaAcre" type="number" value="1">
  </label>
  <label>Kepadatan koloni (koloni/ekar):
    <input id="density" type="number" value="30">
  </label>
  <label>Hasil madu per koloni setahun (kg/koloni/tahun):
    <input id="yieldPerColony" type="number" value="2.5">
  </label>

  <!-- B. Hasil Projek -->
  <div class="section-title">B. Hasil Projek</div>
  <label>Harga Jual Madu (RM/kg):
    <input id="price" type="number" value="200">
  </label>

  <!-- C. Kos Pembangunan (Tahun 0) -->
  <div class="section-title">C. Kos Pembangunan (Tahun 0)</div>
  <label>Pembersihan kawasan (RM/ekar, sekali – tahun 0):
    <input id="clearCostPerAcre" type="number" value="1000">
  </label>
  <label>Pembinaan pagar (RM/ekar, sekali – tahun 0):
    <input id="fenceCostPerAcre" type="number" value="1000">
  </label>
  <label>Pembinaan koloni kelulut (kotak + topping) (RM/koloni, tahun 0):
    <input id="colonySetupCostPerColony" type="number" value="100">
  </label>
  <label>Bilangan alat penyedut madu bermotor (unit – tahun 0):
    <input id="numExtractors" type="number" value="1">
  </label>
  <label>Kos satu alat penyedut madu bermotor (RM/unit):
    <input id="extractorUnitCost" type="number" value="200">
  </label>
  <label>Bilangan bekas simpanan madu (5kg):
    <input id="numContainers" type="number" value="1">
  </label>
  <label>Kos satu bekas simpanan madu 5kg (RM/unit):
    <input id="containerUnitCost" type="number" value="50">
  </label>

  <!-- D. Kos Bahan Input -->
  <div class="section-title">D. Kos Bahan Input</div>
  <label>Kos kawalan serangga (RM/setahun):
    <input id="insectControlAnnual" type="number" value="100">
  </label>

  <!-- E. Kos Tenaga Kerja -->
  <div class="section-title">E. Kos Tenaga Kerja</div>
  <label>Kos tenaga kerja (RM/setahun):
    <input id="labourCostAnnual" type="number" value="6000">
  </label>

  <!-- F. Kos Pelbagai -->
  <div class="section-title">F. Kos Pelbagai (Penyelenggaraan & Utiliti)</div>
  <label>Penyelenggaraan pagar (RM/ekar setiap 3 tahun):
    <input id="fenceMaintPerAcre" type="number" value="300">
  </label>
  <label>Penyelenggaraan / alat ganti alat penyedut madu bermotor (RM/setahun):
    <input id="extractorMaintAnnual" type="number" value="50">
  </label>
  <label>Penggantian kotak koloni + kotak topping (RM/koloni setiap 2 tahun):
    <input id="colonyReplacementCostPerColony" type="number" value="50">
  </label>
  <label>Sewa tanah (RM/ekar setahun – kos utiliti):
    <input id="landRentPerAcreAnnual" type="number" value="500">
  </label>

  <!-- G. Parameter Analisis -->
  <div class="section-title">G. Parameter Analisis</div>
  <label>Kadar Diskaun (% setahun):
    <input id="discountRate" type="number" value="3">
  </label>
  <label>Tempoh Analisis (tahun ekonomi projek):
    <input id="duration" type="number" value="7">
  </label>

  <p class="note">
    Kos tahunan untuk penyelenggaraan pagar (3 tahun sekali) dan penggantian kotak (2 tahun sekali)
    akan ditukar kepada kos tahunan purata (dibahagi 3 atau 2). Kos kontinjensi 10% akan
    ditambah atas jumlah kos setiap tahun.
  </p>

  <button onclick="runAnalysis()">Kira Analisis</button>

  <div id="results" class="summary"></div>

  <!-- H. Graf Visual -->
  <div class="section-title">H. Graf Visual</div>
  <p class="note">
    Graf membantu melihat aliran tunai, bila projek pulang modal dan kesan perubahan harga madu.
  </p>
  <canvas id="cfChart" height="180"></canvas>
  <canvas id="cumCfChart" height="180"></canvas>
  <canvas id="npvSensChart" height="180"></canvas>

  <!-- DISCLAIMER & COPYRIGHT -->
  <p class="note" style="margin-top:20px; font-size:10px; color:#777; line-height:1.4;">
    <strong>Penafian (Disclaimer) – Bahasa Melayu:</strong><br>
    Kalkulator ini disediakan untuk tujuan pembelajaran dan anggaran kasar sahaja.
    Nilai kos, hasil dan pulangan sebenar mungkin berbeza mengikut lokasi, keadaan ternakan,
    kemahiran pengurusan, harga pasaran serta faktor-faktor lain di luar kawalan pengeluar.
    Pengguna dinasihatkan mendapatkan nasihat lanjut daripada pegawai atau pakar berkaitan
    sebelum membuat keputusan pelaburan. Penyedia kalkulator tidak bertanggungjawab
    terhadap sebarang kerugian, kerosakan atau tuntutan yang timbul daripada penggunaan
    kalkulator ini.
  </p>

  <p class="note" style="margin-top:10px; font-size:10px; color:#777; line-height:1.4;">
    <strong>Disclaimer – English Version:</strong><br>
    This calculator is intended for educational use and approximate estimation only.
    Actual costs, yields, and financial returns may vary depending on location, farm conditions,
    management practices, market prices, and other external factors. Users are advised
    to consult relevant officers or experts before making financial or investment decisions.
    The creator of this calculator shall not be held responsible for any loss, damage,
    or claims arising from its use.
  </p>

  <p class="note" style="margin-top:10px; font-size:10px; color:#777; text-align:center;">
    &copy; 2025 Assis Kamu, Universiti Malaysia Sabah. All Rights Reserved.
  </p>

</div> <!-- end container -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let cfChartInstance = null;
  let cumCfChartInstance = null;
  let npvSensChartInstance = null;

  // Format nombor dengan koma ribu
  function fmt(x, decimals = 2) {
    if (x === null || isNaN(x)) return "-";
    return x.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function npv(rate, cashflows) {
    let npvVal = 0;
    for (let t = 0; t < cashflows.length; t++) {
      npvVal += cashflows[t] / Math.pow(1 + rate, t);
    }
    return npvVal;
  }

  function irr(cashflows, guess = 0.1) {
    let rate = guess;
    for (let i = 0; i < 100; i++) {
      let npvVal = 0;
      let dNpv = 0;
      for (let t = 0; t < cashflows.length; t++) {
        let denom = Math.pow(1 + rate, t);
        npvVal += cashflows[t] / denom;
        if (t > 0) {
          dNpv -= t * cashflows[t] / (denom * (1 + rate));
        }
      }
      if (Math.abs(dNpv) < 1e-10) break;
      let newRate = rate - npvVal / dNpv;
      if (Math.abs(newRate - rate) < 1e-7) return newRate;
      rate = newRate;
    }
    return rate;
  }

  function computeScenario(T, areaAcre, density, yieldPerColony, basePrice,
                           devCost0, inputAnnual, labourAnnual, miscAnnual,
                           discountRate, priceFactor, colonies) {

    const price = basePrice * priceFactor;
    const totalKgPerYear = colonies * yieldPerColony;

    let cashflows = [];
    let benefits = [];
    let totalCosts = [];
    let cumCF = 0;
    let paybackYear = null;
    let pvBenefits = 0;
    let pvCosts = 0;

    for (let t = 0; t <= T; t++) {
      let benefit = (t === 0) ? 0 : totalKgPerYear * price;

      let directCost;
      if (t === 0) {
        directCost = devCost0;
      } else {
        directCost = inputAnnual + labourAnnual + miscAnnual;
      }

      let contingency = directCost * 0.10;
      let totalCost = directCost + contingency;

      let cf = benefit - totalCost;

      cashflows.push(cf);
      benefits.push(benefit);
      totalCosts.push(totalCost);

      cumCF += cf;
      if (paybackYear === null && cumCF >= 0 && t > 0) {
        paybackYear = t;
      }

      const df = Math.pow(1 + discountRate, t);
      pvBenefits += benefit / df;
      pvCosts += totalCost / df;
    }

    const npvVal = npv(discountRate, cashflows);
    const irrVal = irr(cashflows) * 100;
    const bcrVal = pvCosts > 0 ? pvBenefits / pvCosts : null;

    return {
      priceFactor,
      price,
      colonies,
      totalKgPerYear,
      cashflows,
      benefits,
      totalCosts,
      npv: npvVal,
      irr: irrVal,
      bcr: bcrVal,
      paybackYear
    };
  }

  function computeBreakEvenPrice(T, areaAcre, density, yieldPerColony,
                                 devCost0, inputAnnual, labourAnnual, miscAnnual,
                                 discountRate, colonies) {

    const totalKgPerYear = colonies * yieldPerColony;

    let pvKg = 0;
    let pvCosts = 0;

    for (let t = 0; t <= T; t++) {
      let benefitKg = (t === 0) ? 0 : totalKgPerYear;

      let directCost;
      if (t === 0) {
        directCost = devCost0;
      } else {
        directCost = inputAnnual + labourAnnual + miscAnnual;
      }

      let contingency = directCost * 0.10;
      let totalCost = directCost + contingency;

      const df = Math.pow(1 + discountRate, t);
      pvKg += benefitKg / df;
      pvCosts += totalCost / df;
    }

    if (pvKg === 0) return null;
    return pvCosts / pvKg;
  }

  function runAnalysis() {
    const areaAcre      = parseFloat(document.getElementById('areaAcre').value);
    const density       = parseFloat(document.getElementById('density').value);
    const yieldPerCol   = parseFloat(document.getElementById('yieldPerColony').value);
    const basePrice     = parseFloat(document.getElementById('price').value);

    const clearCostPerAcre  = parseFloat(document.getElementById('clearCostPerAcre').value);
    const fenceCostPerAcre  = parseFloat(document.getElementById('fenceCostPerAcre').value);

    const colonySetupCostPerColony = parseFloat(document.getElementById('colonySetupCostPerColony').value);
    const numExtractors            = parseFloat(document.getElementById('numExtractors').value);
    const extractorUnitCost        = parseFloat(document.getElementById('extractorUnitCost').value);
    const numContainers            = parseFloat(document.getElementById('numContainers').value);
    const containerUnitCost        = parseFloat(document.getElementById('containerUnitCost').value);
    const insectControlAnnual      = parseFloat(document.getElementById('insectControlAnnual').value);

    const labourAnnual             = parseFloat(document.getElementById('labourCostAnnual').value);

    const fenceMaintPerAcre        = parseFloat(document.getElementById('fenceMaintPerAcre').value);
    const extractorMaintAnnual     = parseFloat(document.getElementById('extractorMaintAnnual').value);
    const colonyReplaceCostPerCol  = parseFloat(document.getElementById('colonyReplacementCostPerColony').value);
    const landRentPerAcreAnnual    = parseFloat(document.getElementById('landRentPerAcreAnnual').value);

    const rPercent = parseFloat(document.getElementById('discountRate').value);
    const T        = parseInt(document.getElementById('duration').value);

    if ([areaAcre, density, yieldPerCol, basePrice,
         clearCostPerAcre, fenceCostPerAcre, colonySetupCostPerColony,
         numExtractors, extractorUnitCost, numContainers, containerUnitCost,
         insectControlAnnual, labourAnnual, fenceMaintPerAcre,
         extractorMaintAnnual, colonyReplaceCostPerCol, landRentPerAcreAnnual,
         rPercent, T].some(v => isNaN(v))) {
      alert("Sila pastikan semua input diisi dengan nombor yang sah.");
      return;
    }

    const r = rPercent / 100;

    // Bilangan koloni dan hasil
    const colonies = areaAcre * density;
    const totalKgPerYear = colonies * yieldPerCol;

    // Kos pembangunan (tahun 0)
    const devCostClearing = areaAcre * clearCostPerAcre;
    const devCostFence    = areaAcre * fenceCostPerAcre;
    const devCostColonies = colonies * colonySetupCostPerColony;
    const devCostExtract  = numExtractors * extractorUnitCost;
    const devCostCont     = numContainers * containerUnitCost;

    const devCost0 = devCostClearing + devCostFence + devCostColonies +
                     devCostExtract + devCostCont;

    // Kos tahunan purata untuk input & penyelenggaraan
    const annualFenceMaintEq    = areaAcre * fenceMaintPerAcre / 3;
    const annualColonyReplaceEq = colonies * colonyReplaceCostPerCol / 2;
    const annualExtractorMaint  = extractorMaintAnnual;
    const annualInsect          = insectControlAnnual;

    const inputAnnual = annualFenceMaintEq + annualColonyReplaceEq +
                        annualExtractorMaint + annualInsect;

    // Kos tenaga kerja & utiliti
    const miscAnnual   = areaAcre * landRentPerAcreAnnual;
    const labourAnnualCost = labourAnnual;

    const baseScenario = computeScenario(
      T, areaAcre, density, yieldPerCol, basePrice,
      devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, 1.0, colonies
    );

    const breakEvenPrice = computeBreakEvenPrice(
      T, areaAcre, density, yieldPerCol,
      devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, colonies
    );

    // ROI (tanpa diskaun)
    const totalBenefits = baseScenario.benefits.reduce((a,b) => a + b, 0);
    const totalCosts    = baseScenario.totalCosts.reduce((a,b) => a + b, 0);
    const roi = totalCosts > 0 ? ( (totalBenefits - totalCosts) / totalCosts ) * 100 : null;

    const paybackText = baseScenario.paybackYear
      ? "Tahun ke-" + baseScenario.paybackYear
      : "Tidak pulang modal dalam tempoh analisis";

    const npvVal = baseScenario.npv;
    const irrVal = baseScenario.irr;
    const bcrVal = baseScenario.bcr;
    const roiVal = roi;

    // Jadual ringkasan penunjuk kewangan
    const metricsTable = `
      <h3>Ringkasan Penunjuk Kewangan &amp; Takrif Ringkas</h3>
      <table>
        <tr>
          <th style="text-align:left;">Penunjuk</th>
          <th>Nilai</th>
          <th style="text-align:left;">Takrif Ringkas</th>
        </tr>
        <tr>
          <td style="text-align:left;">NPV (Nilai Kini Bersih)</td>
          <td>RM ${fmt(npvVal)}</td>
          <td style="text-align:left;">
            Lebihan wang projek selepas tolak semua kos dan ambil kira nilai masa wang.
            Jika NPV &gt; 0, projek biasanya dianggap menguntungkan.
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">IRR (Kadar Pulangan Dalaman)</td>
          <td>${fmt(irrVal)} %</td>
          <td style="text-align:left;">
            Purata kadar pulangan setahun. Jika IRR lebih tinggi daripada kadar diskaun
            (contoh 3–10%), projek dianggap menarik.
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">BCR (Nisbah Faedah-Kos)</td>
          <td>${bcrVal !== null ? bcrVal.toFixed(2) : "-"}</td>
          <td style="text-align:left;">
            Perbandingan jumlah faedah dengan jumlah kos. Jika BCR &gt; 1,
            faedah lebih besar daripada kos.
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">ROI (Pulangan atas Pelaburan)</td>
          <td>${roiVal !== null ? fmt(roiVal) : "-"} %</td>
          <td style="text-align:left;">
            Pulangan kasar berbanding jumlah kos. Contoh ROI = 30% bermaksud setiap RM1 kos
            menghasilkan lebih kurang 30 sen keuntungan sepanjang projek.
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">Harga Pulang Modal (Break-even Price)</td>
          <td>${breakEvenPrice !== null ? "RM " + fmt(breakEvenPrice) + " /kg" : "-"}</td>
          <td style="text-align:left;">
            Harga minimum madu (RM/kg) supaya projek tidak rugi (NPV = 0).
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">Tempoh Pulang Modal (Payback Period)</td>
          <td>${paybackText}</td>
          <td style="text-align:left;">
            Tahun bila jumlah aliran tunai terkumpul mula positif; selepas tahun ini projek
            benar-benar memberi lebihan.
          </td>
        </tr>
      </table>
    `;

    // Kesimpulan
    let conclusionClass = "conclusion-box";
    let conclusionColor = "";
    let conclusionHeader = "";
    let conclusionText = "";
    let suggestionHtml = "<ul>";

    if (npvVal > 0 && irrVal > rPercent && bcrVal !== null && bcrVal > 1 && roiVal !== null && roiVal > 20) {
      conclusionClass += " conclusion-good";
      conclusionColor = "#1b7f36";
      conclusionHeader = "PROJEK BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini menunjukkan pulangan yang baik dan berpotensi memberi keuntungan stabil kepada penternak.";
      suggestionHtml += "<li>Tingkatkan pemasaran (jenama sendiri, jual terus kepada pengguna) untuk kekalkan harga jual di paras tinggi.</li>";
      suggestionHtml += "<li>Kekalkan mutu penjagaan koloni supaya hasil madu per koloni stabil atau meningkat.</li>";
      suggestionHtml += "<li>Beli input secara pukal atau melalui koperasi untuk mengurangkan kos.</li>";
      suggestionHtml += "<li>Boleh tambah bilangan koloni secara berperingkat selepas projek stabil.</li>";
    } else if (npvVal > 0 && bcrVal !== null && bcrVal >= 1) {
      conclusionClass += " conclusion-moderate";
      conclusionColor = "#e68900";
      conclusionHeader = "PROJEK BERBALOI (BERJAGA-JAGA)";
      conclusionText = "Projek ini masih boleh diteruskan tetapi margin keuntungan tidak terlalu besar. Penternak perlu mengawal kos dan berusaha meningkatkan hasil.";
      suggestionHtml += "<li>Naikkan hasil madu per koloni melalui latihan teknikal dan amalan penternakan yang lebih baik.</li>";
      suggestionHtml += "<li>Bandingkan beberapa pembekal input untuk mendapatkan harga yang lebih rendah tanpa menjejaskan kualiti.</li>";
      suggestionHtml += "<li>Kawal kos tenaga kerja supaya selari dengan saiz projek.</li>";
      suggestionHtml += "<li>Manfaatkan bantuan kerajaan, program agropreneur atau geran yang tersedia.</li>";
    } else {
      conclusionClass += " conclusion-bad";
      conclusionColor = "#c62828";
      conclusionHeader = "PROJEK BERISIKO / KURANG BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini kelihatan berisiko atau kurang menguntungkan. Penternak disaran menilai semula sebelum melabur modal yang besar.";
      suggestionHtml += "<li>Cuba tingkatkan harga jual melalui pembungkusan lebih baik, pensijilan atau pemasaran terus kepada pengguna.</li>";
      suggestionHtml += "<li>Tingkatkan hasil per koloni melalui bimbingan teknikal dan pengurusan koloni yang baik.</li>";
      suggestionHtml += "<li>Kurangkan kos pembangunan awal dengan mula pada skala lebih kecil.</li>";
      suggestionHtml += "<li>Kurangkan kos tenaga kerja melalui kerjasama keluarga atau koperasi.</li>";
      suggestionHtml += "<li>Cari bantuan geran, subsidi atau skim sokongan agensi kerajaan untuk mengurangkan beban modal awal.</li>";
    }
    suggestionHtml += "</ul>";

    const conclusionHtml = `
      <div class="${conclusionClass}">
        <div class="conclusion-title" style="color:${conclusionColor};">
          ${conclusionHeader}
        </div>
        <p>${conclusionText}</p>
        <strong>Cara untuk tambah keuntungan / kurangkan risiko:</strong>
        ${suggestionHtml}
      </div>
    `;

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML =
      `<div class="result-box">
         <p><strong>Keluasan:</strong> ${fmt(areaAcre)} ekar</p>
         <p><strong>Kepadatan koloni:</strong> ${density.toFixed(0)} koloni/ekar
            &nbsp;→&nbsp; <strong>Bilangan koloni:</strong> ${fmt(colonies,0)} koloni</p>
         <p><strong>Jumlah hasil madu setahun:</strong> ${fmt(totalKgPerYear)} kg/tahun</p>
         <p><strong>Jumlah kos pembangunan (tahun 0):</strong> RM ${fmt(devCost0)}</p>
         <p><strong>Kos bahan input tahunan setara:</strong> RM ${fmt(inputAnnual)} / tahun</p>
         <p><strong>Kos tenaga kerja tahunan:</strong> RM ${fmt(labourAnnualCost)} / tahun</p>
         <p><strong>Kos pelbagai & utiliti (sewa tanah) tahunan:</strong> RM ${fmt(miscAnnual)} / tahun</p>
         <hr>
         ${metricsTable}
       </div>
       ${conclusionHtml}
      `;

    // Jadual aliran tunai
    let table = "<h3>Jadual Aliran Tunai</h3>";
    table += "<table><tr><th>Tahun</th><th>Hasil (RM)</th><th>Jumlah Kos (RM)</th><th>CF (RM)</th></tr>";
    for (let t = 0; t <= T; t++) {
      table += `<tr>
        <td style="text-align:center">${t}</td>
        <td>${fmt(baseScenario.benefits[t])}</td>
        <td>${fmt(baseScenario.totalCosts[t])}</td>
        <td>${fmt(baseScenario.cashflows[t])}</td>
      </tr>`;
    }
    table += "</table>";
    resultsDiv.innerHTML += table;

    // Analisis sensitiviti harga
    let sensTable = "<h3>Analisis Sensitiviti Harga (NPV, IRR, BCR)</h3>";
    sensTable += "<table><tr><th>Senario</th><th>Faktor Harga</th><th>Harga/kg (RM)</th><th>NPV (RM)</th><th>IRR (%)</th><th>BCR</th></tr>";

    const factors = [0.8, 0.9, 1.0, 1.1, 1.2];
    const sensLabels = [];
    const sensNPV = [];

    factors.forEach((f, idx) => {
      const sc = computeScenario(
        T, areaAcre, density, yieldPerCol, basePrice,
        devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, f, colonies
      );
      sensLabels.push((f * 100).toFixed(0) + "%");
      sensNPV.push(sc.npv);

      sensTable += `<tr>
        <td style="text-align:center">${idx + 1}</td>
        <td>${(f * 100).toFixed(0)}%</td>
        <td>${fmt(sc.price)}</td>
        <td>${fmt(sc.npv)}</td>
        <td>${sc.irr.toFixed(2)}</td>
        <td>${sc.bcr !== null ? sc.bcr.toFixed(2) : "-"}</td>
      </tr>`;
    });

    sensTable += "</table>";
    resultsDiv.innerHTML += sensTable;

    resultsDiv.innerHTML += `
      <p class="note">
        Nota: Kos kontinjensi 10% telah ditambah secara automatik pada setiap tahun
        atas jumlah kos langsung (pembangunan, bahan input, tenaga kerja dan pelbagai).
      </p>
    `;

    // -------- GRAF 1: Aliran Tunai Bersih --------
    const yearLabels = [];
    const cfData = [];
    let cum = 0;
    const cumData = [];

    for (let t = 0; t <= T; t++) {
      yearLabels.push("Tahun " + t);
      const cf = baseScenario.cashflows[t];
      cfData.push(cf);
      cum += cf;
      cumData.push(cum);
    }

    if (cfChartInstance) cfChartInstance.destroy();
    const cfCtx = document.getElementById('cfChart').getContext('2d');
    cfChartInstance = new Chart(cfCtx, {
      type: 'bar',
      data: {
        labels: yearLabels,
        datasets: [{
          label: 'Aliran Tunai Bersih (RM)',
          data: cfData,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // -------- GRAF 2: Aliran Tunai Terkumpul --------
    if (cumCfChartInstance) cumCfChartInstance.destroy();
    const cumCtx = document.getElementById('cumCfChart').getContext('2d');
    cumCfChartInstance = new Chart(cumCtx, {
      type: 'line',
      data: {
        labels: yearLabels,
        datasets: [{
          label: 'Aliran Tunai Terkumpul (RM)',
          data: cumData,
          fill: false,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.3)',
          tension: 0.2,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // -------- GRAF 3: NPV vs Faktor Harga --------
    if (npvSensChartInstance) npvSensChartInstance.destroy();
    const npvCtx = document.getElementById('npvSensChart').getContext('2d');
    npvSensChartInstance = new Chart(npvCtx, {
      type: 'bar',
      data: {
        labels: sensLabels,
        datasets: [{
          label: 'NPV mengikut Senario Harga (RM)',
          data: sensNPV,
          backgroundColor: [
            'rgba(255, 99, 132, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(255, 205, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(54, 162, 235, 0.6)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(54, 162, 235, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
</body>
</html>
