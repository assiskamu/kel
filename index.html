<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KALKULATOR PROJEK MADU KELULUT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    h1, h2 { text-align: center; }
    .container { max-width: 750px; margin: auto; }
    label { display: block; margin-top: 8px; font-size: 14px; }
    input { width: 100%; padding: 6px; box-sizing: border-box; font-size: 14px; }
    button { margin-top: 12px; width: 100%; padding: 10px; font-size: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: right; }
    th { background: #f0f0f0; }
    .summary p { margin: 4px 0; }
    .note { font-size: 11px; color: #555; margin-top: 6px; }
    .section-title { margin-top: 15px; font-weight: bold; text-decoration: underline; }
    canvas { margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Kalkulator Projek Madu Kelulut</h1>
  <h2>Analisis Kewangan</h2>

  <p class="note">
    Kalkulator ini menggunakan unit <strong>ekar</strong> (bukan hektar), dengan pecahan kos:
    pembangunan, bahan input, tenaga kerja dan pelbagai (penyelenggaraan + utiliti).
    Kos kontinjensi 10% ditambah ke atas jumlah kos untuk setiap tahun.
  </p>

  <!-- A. Maklumat Ladang -->
  <div class="section-title">A. Maklumat Ladang</div>
  <label>Keluasan (ekar):
    <input id="areaAcre" type="number" value="5">
  </label>
  <label>Kepadatan koloni (koloni/ekar):
    <input id="density" type="number" value="50">
  </label>
  <label>Hasil madu per koloni setahun (kg/koloni/tahun):
    <input id="yieldPerColony" type="number" value="2.5">
  </label>

  <!-- B. Hasil Projek -->
  <div class="section-title">B. Hasil Projek</div>
  <label>Harga Jual Madu (RM/kg):
    <input id="price" type="number" value="200">
  </label>

  <!-- C. Kos Pembangunan (Tahun 0) -->
  <div class="section-title">C. Kos Pembangunan (Tahun 0)</div>
  <label>Pembersihan kawasan (RM/ekar, sekali – tahun 0):
    <input id="clearCostPerAcre" type="number" value="2500">
  </label>
  <label>Pembinaan pagar (RM/ekar, sekali – tahun 0):
    <input id="fenceCostPerAcre" type="number" value="3000">
  </label>

  <!-- D. Kos Bahan Input -->
  <div class="section-title">D. Kos Bahan Input</div>
  <label>Pembinaan koloni kelulut (kotak koloni + kotak topping)
    (RM/koloni, sekali – tahun 0):
    <input id="colonySetupCostPerColony" type="number" value="1000">
  </label>
  <label>Bilangan alat penyedut madu bermotor (unit – tahun 0):
    <input id="numExtractors" type="number" value="2">
  </label>
  <label>Kos satu alat penyedut madu bermotor (RM/unit):
    <input id="extractorUnitCost" type="number" value="200">
  </label>
  <label>Bilangan bekas simpanan madu (5kg):
    <input id="numContainers" type="number" value="10">
  </label>
  <label>Kos satu bekas simpanan madu 5kg (RM/unit):
    <input id="containerUnitCost" type="number" value="50">
  </label>
  <label>Kos kawalan serangga (RM/setahun):
    <input id="insectControlAnnual" type="number" value="200">
  </label>

  <!-- E. Kos Tenaga Kerja -->
  <div class="section-title">E. Kos Tenaga Kerja</div>
  <label>Kos tenaga kerja (RM/setahun):
    <input id="labourCostAnnual" type="number" value="28800">
  </label>

  <!-- F. Kos Pelbagai (Penyelenggaraan & Utiliti) -->
  <div class="section-title">F. Kos Pelbagai</div>
  <label>Penyelenggaraan pagar (RM/ekar setiap 3 tahun)
    – contoh: RM500/ekar setiap 3 tahun:
    <input id="fenceMaintPerAcre" type="number" value="500">
  </label>
  <label>Penyelenggaraan / alat ganti alat penyedut madu bermotor
    (RM/setahun – kecil, contoh RM100 setahun):
    <input id="extractorMaintAnnual" type="number" value="100">
  </label>
  <label>Penggantian kotak koloni + kotak topping
    (RM/koloni setiap 2 tahun – contoh RM100/koloni):
    <input id="colonyReplacementCostPerColony" type="number" value="100">
  </label>
  <label>Sewa tanah (RM/ekar setahun – kos utiliti):
    <input id="landRentPerAcreAnnual" type="number" value="500">
  </label>

  <!-- G. Parameter Analisis -->
  <div class="section-title">G. Parameter Analisis</div>
  <label>Kadar Diskaun (% setahun):
    <input id="discountRate" type="number" value="10">
  </label>

  <label>Tempoh Analisis (tahun ekonomi projek):
    <input id="duration" type="number" value="7">
  </label>

  <p class="note">
    Kos tahunan untuk penyelenggaraan pagar (3 tahun sekali) dan penggantian kotak (2 tahun sekali)
    akan ditukar kepada kos tahunan purata (dibahagi 3 atau 2) supaya pengiraan lebih mudah.
    Kos kontinjensi 10% akan ditambah atas jumlah kos setiap tahun.
  </p>

  <button onclick="runAnalysis()">Kira Analisis</button>

  <div id="results" class="summary"></div>

  <div class="section-title">H. Graf Visual</div>
  <p class="note">
    Graf membantu penternak melihat aliran tunai, bila pulang modal,
    dan kesan perubahan harga madu.
  </p>
  <canvas id="cfChart" height="180"></canvas>
  <canvas id="cumCfChart" height="180"></canvas>
  <canvas id="npvSensChart" height="180"></canvas>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Simpan instance graf supaya boleh destroy bila kira semula
  let cfChartInstance = null;
  let cumCfChartInstance = null;
  let npvSensChartInstance = null;

  function npv(rate, cashflows) {
    let npvVal = 0;
    for (let t = 0; t < cashflows.length; t++) {
      npvVal += cashflows[t] / Math.pow(1 + rate, t);
    }
    return npvVal;
  }

  function irr(cashflows, guess = 0.1) {
    let rate = guess;
    for (let i = 0; i < 100; i++) {
      let npvVal = 0;
      let dNpv = 0;
      for (let t = 0; t < cashflows.length; t++) {
        let denom = Math.pow(1 + rate, t);
        npvVal += cashflows[t] / denom;
        if (t > 0) {
          dNpv -= t * cashflows[t] / (denom * (1 + rate));
        }
      }
      if (Math.abs(dNpv) < 1e-10) break;
      let newRate = rate - npvVal / dNpv;
      if (Math.abs(newRate - rate) < 1e-7) return newRate;
      rate = newRate;
    }
    return rate;
  }

  // Kira senario satu harga
  function computeScenario(T, areaAcre, density, yieldPerColony, basePrice,
                           devCost0, inputAnnual, labourAnnual, miscAnnual,
                           discountRate, priceFactor, colonies) {

    const price = basePrice * priceFactor;
    const totalKgPerYear = colonies * yieldPerColony;

    let cashflows = [];
    let benefits = [];
    let totalCosts = [];

    let cumCF = 0;
    let paybackYear = null;
    let pvBenefits = 0;
    let pvCosts = 0;

    for (let t = 0; t <= T; t++) {
      let benefit = (t === 0) ? 0 : totalKgPerYear * price;

      let directCost;
      if (t === 0) {
        directCost = devCost0;
      } else {
        directCost = inputAnnual + labourAnnual + miscAnnual;
      }

      let contingency = directCost * 0.10;
      let totalCost = directCost + contingency;

      let cf = benefit - totalCost;

      cashflows.push(cf);
      benefits.push(benefit);
      totalCosts.push(totalCost);

      cumCF += cf;
      if (paybackYear === null && cumCF >= 0 && t > 0) {
        paybackYear = t;
      }

      const df = Math.pow(1 + discountRate, t);
      pvBenefits += benefit / df;
      pvCosts += totalCost / df;
    }

    const npvVal = npv(discountRate, cashflows);
    const irrVal = irr(cashflows) * 100;
    const bcrVal = pvCosts > 0 ? pvBenefits / pvCosts : null;

    return {
      priceFactor,
      price,
      colonies,
      totalKgPerYear,
      cashflows,
      benefits,
      totalCosts,
      npv: npvVal,
      irr: irrVal,
      bcr: bcrVal,
      paybackYear
    };
  }

  // Harga pulang modal (RM/kg) – NPV = 0 (anggaran linear)
  function computeBreakEvenPrice(T, areaAcre, density, yieldPerColony,
                                 devCost0, inputAnnual, labourAnnual, miscAnnual,
                                 discountRate, colonies) {

    const totalKgPerYear = colonies * yieldPerColony;

    let pvKg = 0;
    let pvCosts = 0;

    for (let t = 0; t <= T; t++) {
      let benefitKg = (t === 0) ? 0 : totalKgPerYear;

      let directCost;
      if (t === 0) {
        directCost = devCost0;
      } else {
        directCost = inputAnnual + labourAnnual + miscAnnual;
      }

      let contingency = directCost * 0.10;
      let totalCost = directCost + contingency;

      const df = Math.pow(1 + discountRate, t);
      pvKg += benefitKg / df;
      pvCosts += totalCost / df;
    }

    if (pvKg === 0) return null;
    return pvCosts / pvKg;
  }

  function runAnalysis() {
    const areaAcre      = parseFloat(document.getElementById('areaAcre').value);
    const density       = parseFloat(document.getElementById('density').value);
    const yieldPerCol   = parseFloat(document.getElementById('yieldPerColony').value);
    const basePrice     = parseFloat(document.getElementById('price').value);

    const clearCostPerAcre  = parseFloat(document.getElementById('clearCostPerAcre').value);
    const fenceCostPerAcre  = parseFloat(document.getElementById('fenceCostPerAcre').value);

    const colonySetupCostPerColony = parseFloat(document.getElementById('colonySetupCostPerColony').value);
    const numExtractors            = parseFloat(document.getElementById('numExtractors').value);
    const extractorUnitCost        = parseFloat(document.getElementById('extractorUnitCost').value);
    const numContainers            = parseFloat(document.getElementById('numContainers').value);
    const containerUnitCost        = parseFloat(document.getElementById('containerUnitCost').value);
    const insectControlAnnual      = parseFloat(document.getElementById('insectControlAnnual').value);

    const labourAnnual             = parseFloat(document.getElementById('labourCostAnnual').value);

    const fenceMaintPerAcre        = parseFloat(document.getElementById('fenceMaintPerAcre').value);
    const extractorMaintAnnual     = parseFloat(document.getElementById('extractorMaintAnnual').value);
    const colonyReplaceCostPerCol  = parseFloat(document.getElementById('colonyReplacementCostPerColony').value);
    const landRentPerAcreAnnual    = parseFloat(document.getElementById('landRentPerAcreAnnual').value);

    const rPercent = parseFloat(document.getElementById('discountRate').value);
    const T        = parseInt(document.getElementById('duration').value);

    if ([areaAcre, density, yieldPerCol, basePrice,
         clearCostPerAcre, fenceCostPerAcre, colonySetupCostPerColony,
         numExtractors, extractorUnitCost, numContainers, containerUnitCost,
         insectControlAnnual, labourAnnual, fenceMaintPerAcre,
         extractorMaintAnnual, colonyReplaceCostPerCol, landRentPerAcreAnnual,
         rPercent, T].some(v => isNaN(v))) {
      alert("Sila pastikan semua input diisi dengan nombor yang sah.");
      return;
    }

    const r = rPercent / 100;

    // Bilangan koloni dan hasil
    const colonies = areaAcre * density;
    const totalKgPerYear = colonies * yieldPerCol;

    // KOS PEMBANGUNAN (tahun 0)
    const devCostClearing = areaAcre * clearCostPerAcre;
    const devCostFence    = areaAcre * fenceCostPerAcre;
    const devCostColonies = colonies * colonySetupCostPerColony;
    const devCostExtract  = numExtractors * extractorUnitCost;
    const devCostCont     = numContainers * containerUnitCost;

    const devCost0 = devCostClearing + devCostFence + devCostColonies +
                     devCostExtract + devCostCont;

    // KOS TAHUNAN PURATA UNTUK BAHAN INPUT & PENYELENGGARAAN
    const annualFenceMaintEq    = areaAcre * fenceMaintPerAcre / 3;          // 3 tahun sekali
    const annualColonyReplaceEq = colonies * colonyReplaceCostPerCol / 2;    // 2 tahun sekali
    const annualExtractorMaint  = extractorMaintAnnual;                      // tiap tahun
    const annualInsect          = insectControlAnnual;                       // tiap tahun

    const inputAnnual = annualFenceMaintEq + annualColonyReplaceEq +
                        annualExtractorMaint + annualInsect;

    // KOS TENAGA KERJA & UTILITI (SEWA TANAH)
    const miscAnnual   = areaAcre * landRentPerAcreAnnual;
    const labourAnnualCost = labourAnnual;

    const factors = [0.8, 0.9, 1.0, 1.1, 1.2];

    const baseScenario = computeScenario(
      T, areaAcre, density, yieldPerCol, basePrice,
      devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, 1.0, colonies
    );

    const breakEvenPrice = computeBreakEvenPrice(
      T, areaAcre, density, yieldPerCol,
      devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, colonies
    );

    const paybackText = baseScenario.paybackYear
      ? "Tahun ke-" + baseScenario.paybackYear
      : "Tidak pulang modal dalam tempoh analisis";

    // Jadual aliran tunai
    let table = "<h3>Jadual Aliran Tunai</h3>";
    table += "<table><tr><th>Tahun</th><th>Hasil (RM)</th><th>Jumlah Kos (RM)</th><th>CF (RM)</th></tr>";
    for (let t = 0; t <= T; t++) {
      table += `<tr>
        <td style="text-align:center">${t}</td>
        <td>${baseScenario.benefits[t].toFixed(2)}</td>
        <td>${baseScenario.totalCosts[t].toFixed(2)}</td>
        <td>${baseScenario.cashflows[t].toFixed(2)}</td>
      </tr>`;
    }
    table += "</table>";

    // Analisis sensitiviti harga
    let sensTable = "<h3>Analisis Sensitiviti Harga (NPV, IRR, BCR)</h3>";
    sensTable += "<table><tr><th>Senario</th><th>Faktor Harga</th><th>Harga/kg (RM)</th><th>NPV (RM)</th><th>IRR (%)</th><th>BCR</th></tr>";

    const sensLabels = [];
    const sensNPV = [];

    factors.forEach((f, idx) => {
      const sc = computeScenario(
        T, areaAcre, density, yieldPerCol, basePrice,
        devCost0, inputAnnual, labourAnnualCost, miscAnnual, r, f, colonies
      );
      sensLabels.push((f * 100).toFixed(0) + "%");
      sensNPV.push(sc.npv);

      sensTable += `<tr>
        <td style="text-align:center">${idx + 1}</td>
        <td>${(f * 100).toFixed(0)}%</td>
        <td>${sc.price.toFixed(2)}</td>
        <td>${sc.npv.toFixed(2)}</td>
        <td>${sc.irr.toFixed(2)}</td>
        <td>${sc.bcr !== null ? sc.bcr.toFixed(2) : "-"}</td>
      </tr>`;
    });

    sensTable += "</table>";

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML =
      `<p><strong>Keluasan:</strong> ${areaAcre.toFixed(2)} ekar</p>
       <p><strong>Kepadatan koloni:</strong> ${density.toFixed(0)} koloni/ekar
          &nbsp;→&nbsp; <strong>Bilangan koloni:</strong> ${colonies.toFixed(0)} koloni</p>
       <p><strong>Jumlah hasil madu setahun:</strong> ${totalKgPerYear.toFixed(2)} kg/tahun</p>
       <p><strong>Jumlah kos pembangunan (tahun 0):</strong> RM ${devCost0.toFixed(2)}</p>
       <p><strong>Kos bahan input tahunan setara:</strong> RM ${inputAnnual.toFixed(2)} / tahun</p>
       <p><strong>Kos tenaga kerja tahunan:</strong> RM ${labourAnnualCost.toFixed(2)} / tahun</p>
       <p><strong>Kos pelbagai & utiliti (sewa tanah) tahunan:</strong> RM ${miscAnnual.toFixed(2)} / tahun</p>
       <hr>
       <p><strong>NPV (Nilai Kini Bersih):</strong> RM ${baseScenario.npv.toFixed(2)}</p>
       <p><strong>IRR (Kadar Pulangan Dalaman):</strong> ${baseScenario.irr.toFixed(2)} %</p>
       <p><strong>BCR (Nisbah Faedah-Kos):</strong> ${baseScenario.bcr !== null ? baseScenario.bcr.toFixed(2) : "-"}</p>
       <p><strong>Harga Pulang Modal (RM/kg):</strong> ${breakEvenPrice !== null ? breakEvenPrice.toFixed(2) : "-"}</p>
       <p><strong>Tempoh Pulang Modal:</strong> ${paybackText}</p>
       <div class="note">
         <strong>Takrif ringkas untuk penternak:</strong>
         <ul>
           <li><strong>NPV &gt; 0</strong> &rarr; projek beri lebihan wang selepas tolak semua kos
             dan ambil kira nilai masa wang. Lebih besar NPV, lebih baik.</li>
           <li><strong>IRR</strong> ialah purata kadar pulangan setahun. Jika
             IRR <strong>lebih tinggi</strong> daripada kadar diskaun (contoh 10%), projek dianggap
             menarik.</li>
           <li><strong>BCR &gt; 1</strong> bermaksud jumlah faedah (hasil) lebih besar daripada
             jumlah kos. Jika BCR &lt; 1, projek kurang berbaloi.</li>
           <li><strong>Harga pulang modal</strong> ialah harga minimum madu (RM/kg) yang perlu
             dicapai supaya projek <strong>tidak rugi</strong> (NPV = 0).</li>
           <li><strong>Tempoh pulang modal</strong> ialah tahun bila jumlah aliran tunai terkumpul
             mula menjadi positif – selepas tahun itu, projek mula betul-betul
             memberi lebihan.</li>
         </ul>
       </div>
       ${table}
       ${sensTable}
       <p class="note">
         Nota: Kos kontinjensi 10% telah ditambah secara automatik pada setiap tahun
         atas jumlah kos langsung (pembangunan, bahan input, tenaga kerja dan pelbagai).
       </p>`;

    // ---------------- GRAF 1: Aliran Tunai Bersih ----------------
    const yearLabels = [];
    const cfData = [];
    let cum = 0;
    const cumData = [];

    for (let t = 0; t <= T; t++) {
      yearLabels.push("Tahun " + t);
      const cf = baseScenario.cashflows[t];
      cfData.push(cf);
      cum += cf;
      cumData.push(cum);
    }

    if (cfChartInstance) cfChartInstance.destroy();
    const cfCtx = document.getElementById('cfChart').getContext('2d');
    cfChartInstance = new Chart(cfCtx, {
      type: 'bar',
      data: {
        labels: yearLabels,
        datasets: [{
          label: 'Aliran Tunai Bersih (RM)',
          data: cfData,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // ---------------- GRAF 2: Aliran Tunai Terkumpul ----------------
    if (cumCfChartInstance) cumCfChartInstance.destroy();
    const cumCtx = document.getElementById('cumCfChart').getContext('2d');
    cumCfChartInstance = new Chart(cumCtx, {
      type: 'line',
      data: {
        labels: yearLabels,
        datasets: [{
          label: 'Aliran Tunai Terkumpul (RM)',
          data: cumData,
          fill: false,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.3)',
          tension: 0.2,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // ---------------- GRAF 3: NPV vs Faktor Harga ----------------
    if (npvSensChartInstance) npvSensChartInstance.destroy();
    const npvCtx = document.getElementById('npvSensChart').getContext('2d');
    npvSensChartInstance = new Chart(npvCtx, {
      type: 'bar',
      data: {
        labels: sensLabels,
        datasets: [{
          label: 'NPV mengikut Senario Harga (RM)',
          data: sensNPV,
          backgroundColor: [
            'rgba(255, 99, 132, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(255, 205, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(54, 162, 235, 0.6)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(54, 162, 235, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
</body>
</html>
